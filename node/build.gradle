apply from: 'https://raw.github.com/evgeny-goldin/scripts/master/src/main/gradle/wrapper.gradle'

buildscript {
    repositories { mavenLocal(); maven { url 'http://evgenyg.artifactoryonline.com/evgenyg/repo/' }}
    dependencies { classpath 'com.github.goldin.plugins.gradle:node:0.2-SNAPSHOT' }
}

defaultTasks 'clean', 'cleanModules', 'start', 'restartall', 'stop', 'stopall'

println "> Running Gradle [${ project.gradle.gradleVersion }], Groovy [${ GroovySystem.version }], Java [${ System.getProperty( 'java.version' ) }]"

subprojects {
    Project p ->

    apply plugin: 'node'

    clean.doFirst {
        if ( System.getProperty( 'cleanNode' ) != null )
        {
            final deleteFiles = [ new File( System.getProperty( 'user.home' ), '.npm' ),
                                  new File( System.getProperty( 'user.home' ), '.nvm' ) ]

            println "Deleting $deleteFiles"
            project.delete( deleteFiles )
        }
    }

    node {
        checkContent  = p.name
        pidOnlyToStop = false

        if ( new File( p.projectDir, 'config' ).directory )
        {
            portNumber = 3000 + ( Math.abs( p.name.hashCode()) % 100 )
            configs    = [[ 'config/development.json' : [ port : portNumber ]]]
        }
    }
}
